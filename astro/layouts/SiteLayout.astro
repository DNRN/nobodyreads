---
import type { LayoutOptions } from "../../src/content/types.js";
import { escapeHtml } from "../../src/shared/http.js";
import { buildMetaTags, buildStructuredData, navHref } from "../../src/shared/seo.js";
import { initDb } from "../../src/shared/db.js";
import { DEFAULT_TENANT_ID } from "../../src/shared/types.js";
import { getSiteBundle } from "../../src/shared/site-bundle.js";
import { DEFAULT_SITE_TEMPLATE } from "../../src/shared/site-template.js";

const { options, authLinksHtml } = Astro.props as {
  options: LayoutOptions;
  authLinksHtml?: string;
};

const siteName = options.siteName ?? (process.env.SITE_NAME || "nobodyreads.me");
const siteTagline =
  options.siteTagline ??
  (process.env.SITE_TAGLINE ||
    "Another simple blog engine. For writing mostly to yourself.");
const homeHref = options.urlPrefix || "/";
const navItems = options.navItems ?? [];
const activePageId = options.activePageId;

const metaTags = buildMetaTags({ ...options, siteName, siteTagline });
const structuredData = buildStructuredData({ ...options, siteName, siteTagline });

const scriptTags = (options.scripts ?? [])
  .map((s) => `  <script type="module" src="${escapeHtml(s)}"></script>`)
  .join("\n");

const devReload = import.meta.env.DEV
  ? `  <script>new EventSource("/__reload").onmessage = e => { if (e.data === "reload") location.reload(); };</script>`
  : "";

const db = await initDb();
const siteBundle = await getSiteBundle(db, DEFAULT_TENANT_ID);
const slotHtml = await Astro.slots.render("default");
const navHtml = navItems
  .map((item) => {
    const href = escapeHtml(navHref(item, options.urlPrefix));
    const label = escapeHtml(item.label);
    const active = item.id === activePageId ? ' class="active"' : "";
    return `<a href="${href}"${active}>${label}</a>`;
  })
  .join("");
const authLinksBlock = authLinksHtml
  ? `<nav class="site-menu" id="site-menu" data-nav aria-label="Profile">
      <span class="nav-auth nav-auth--menu">${authLinksHtml}</span>
     </nav>`
  : "";
const navToggle = authLinksHtml
  ? `<button class="nav-toggle" type="button" data-nav-toggle aria-label="Toggle menu" aria-controls="site-menu" aria-expanded="false">
      <span></span><span></span><span></span>
     </button>`
  : "";
const templateHtml = siteBundle?.html?.trim() ? siteBundle.html : DEFAULT_SITE_TEMPLATE;
let bodyHtml = templateHtml
  .replaceAll("{{nav}}", navHtml)
  .replaceAll("{{authLinksBlock}}", authLinksBlock)
  .replaceAll("{{navToggle}}", navToggle)
  .replaceAll("{{siteTagline}}", escapeHtml(siteTagline))
  .replaceAll("{{homeHref}}", escapeHtml(homeHref))
  .replaceAll("{{year}}", `${new Date().getFullYear()}`);
bodyHtml = bodyHtml.includes("{{content}}")
  ? bodyHtml.replaceAll("{{content}}", slotHtml)
  : `${bodyHtml}\n${slotHtml}`;
const bundleCss = siteBundle?.css?.trim() ? siteBundle.css : "";
const bundleJs = siteBundle?.js?.trim() ? siteBundle.js : "";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{options.title}</title>
    <script is:inline>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = (stored === "system" || !stored)
            ? (prefersDark ? "dark" : "light")
            : (stored === "dark" || stored === "light"
                ? stored
                : (prefersDark ? "dark" : "light"));
          document.documentElement.dataset.theme = theme;
        } catch {
          document.documentElement.dataset.theme = "light";
        }
      })();
    </script>
    <Fragment set:html={metaTags} />
    <Fragment set:html={structuredData} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
    />
    {!bundleCss ? <link rel="stylesheet" href="/style.css" /> : null}
    {bundleCss ? <style set:html={bundleCss} /> : null}
    <Fragment set:html={scriptTags} />
    <Fragment set:html={devReload} />
  </head>
  <body>
    <Fragment set:html={bodyHtml} />
    {bundleJs ? <script type="module" set:html={bundleJs} /> : null}
  </body>
</html>
