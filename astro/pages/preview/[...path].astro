---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getPageBySlug, getNavItems } from "../../../src/content/db.js";
import type { Page } from "../../../src/content/types.js";
import { resolveLinks, renderMarkdown } from "../../../src/content/render.js";
import { editorRequiresAuth, isAuthenticatedRequest } from "../../../src/editor/auth.js";
import { DEFAULT_TENANT_ID } from "../../../src/shared/types.js";
import {
  getLatestSiteBundleRevision,
  getLatestSiteBundleRevisionId,
} from "../../../src/shared/site-bundle.js";
import { getDbClient } from "../../lib/db.js";
import { formatDate, pagePath } from "../../lib/format.js";

if (editorRequiresAuth() && !isAuthenticatedRequest(Astro.request)) {
  return Astro.redirect("/admin/login");
}

Astro.response.headers.set("X-Robots-Tag", "noindex, nofollow, noai, noimageai");

const tenantId = process.env.TENANT_ID || DEFAULT_TENANT_ID;
const previewUrlPrefix = "/preview";
const siteName = process.env.SITE_NAME || "nobodyreads.me";
const siteTagline =
  process.env.SITE_TAGLINE ||
  "Another simple blog engine. For writing mostly to yourself.";

const db = await getDbClient();
const [siteBundle, latestRevisionId, navItems] = await Promise.all([
  getLatestSiteBundleRevision(db, tenantId),
  getLatestSiteBundleRevisionId(db, tenantId),
  getNavItems(db, tenantId),
]);

const autoReloadScript = `(() => {
  let currentRevisionId = ${latestRevisionId ?? "null"};
  const pollIntervalMs = 1500;
  const endpoint = "/preview/revision.json";

  const schedule = () => window.setTimeout(check, pollIntervalMs);

  async function check() {
    try {
      const response = await fetch(endpoint, {
        method: "GET",
        credentials: "same-origin",
        cache: "no-store",
      });

      if (response.status === 401) {
        window.location.assign("/admin/login");
        return;
      }

      if (!response.ok) {
        schedule();
        return;
      }

      const data = await response.json();
      const nextRevisionId = typeof data.revisionId === "number" ? data.revisionId : null;
      if (nextRevisionId !== currentRevisionId) {
        window.location.reload();
        return;
      }
    } catch {
      // Keep polling even on transient network/runtime errors.
    }

    schedule();
  }

  schedule();
})();`;

const rawPath = Astro.params.path ?? "";
const segments = rawPath
  .split("/")
  .map((segment) => segment.trim())
  .filter(Boolean);

let page: Page | null = null;
let pageKind: "post" | "page" | null = null;

if (segments.length === 2 && segments[0] === "posts") {
  page = await getPageBySlug(db, segments[1], "post", tenantId);
  pageKind = "post";
} else if (segments.length === 1) {
  page = await getPageBySlug(db, segments[0], "page", tenantId);
  pageKind = "page";
} else {
  Astro.response.status = 404;
}

if (page?.seo?.noAiTraining) {
  Astro.response.headers.set("X-Robots-Tag", "noindex, nofollow, noai, noimageai");
}

let htmlBody = "";
if (page) {
  const resolved = await resolveLinks(db, page.content, tenantId, previewUrlPrefix);
  htmlBody = renderMarkdown(resolved);
} else {
  Astro.response.status = 404;
}

const options = page
  ? {
      title: `${page.title} — ${siteName}`,
      navItems,
      activePageId: page.id,
      scripts: page.scripts,
      description: page.seo?.metaDescription || page.excerpt,
      pathname: pagePath(page, previewUrlPrefix),
      ogType: pageKind === "post" ? "article" : undefined,
      seo: page.seo,
      page,
      urlPrefix: previewUrlPrefix,
      siteName,
      siteTagline,
    }
  : {
      title: `404 — ${siteName}`,
      navItems,
      seo: { noIndex: true },
      urlPrefix: previewUrlPrefix,
      siteName,
      siteTagline,
    };
---
<SiteLayout options={options} siteBundleOverride={siteBundle}>
  {page ? (
    <>
      <div class="post-header">
        {pageKind === "post" ? (
          <time class="post-date" datetime={page.date}>{formatDate(page.date)}</time>
        ) : null}
        <h2 class="post-title">{page.title}</h2>
      </div>
      <div class={pageKind === "post" ? "post-body" : "page-body"} set:html={htmlBody} />
      <a href={previewUrlPrefix} class="back-link">
        {pageKind === "post" ? "\u2190 back to all posts" : "\u2190 back to home"}
      </a>
    </>
  ) : (
    <>
      <div class="post-header">
        <h2 class="post-title">Not found</h2>
      </div>
      <p>There's nothing here.</p>
      <a href={previewUrlPrefix} class="back-link">&larr; back to home</a>
    </>
  )}
  <script is:inline set:html={autoReloadScript}></script>
</SiteLayout>
