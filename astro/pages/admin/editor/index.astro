---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { editorRequiresAuth, isAuthenticatedRequest } from "../../../../src/editor/auth.js";
import { initDb } from "../../../../src/shared/db.js";
import { DEFAULT_TENANT_ID } from "../../../../src/shared/types.js";
import { listAllPages } from "../../../../src/content/db.js";
import type { Page } from "../../../../src/content/types.js";

if (editorRequiresAuth() && !isAuthenticatedRequest(Astro.request)) {
  return Astro.redirect("/admin/login");
}

const db = await initDb();
const pages = await listAllPages(db, DEFAULT_TENANT_ID);

const groups: Record<string, Page[]> = { home: [], page: [], post: [] };
for (const page of pages) {
  const bucket = groups[page.kind] ?? [];
  bucket.push(page);
  groups[page.kind] = bucket;
}

function formatDate(iso: string): string {
  const d = new Date(iso);
  return d.toLocaleDateString("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
}

function kindLabel(kind: string): string {
  if (kind === "home") return "Home";
  if (kind === "post") return "Post";
  return "Page";
}
---
<AdminLayout title="Content â€” Admin">
  <main class="container">
    <div class="editor-list">
      <div class="editor-list-header">
        <h2>Content</h2>
        <a href="/admin/editor/new" class="btn btn-primary">New page</a>
      </div>
      {pages.length === 0 ? (
        <p class="editor-empty">No pages yet. Create your first one!</p>
      ) : null}
      {(["home", "page", "post"] as const).map((kind) => {
        const items = groups[kind];
        if (items.length === 0) return null;
        return (
          <div class="editor-list-section">
            <h3>{kindLabel(kind)}s</h3>
            <table class="editor-table">
              <thead>
                <tr><th>Title</th><th>URL</th><th>Status</th><th>Date</th></tr>
              </thead>
              <tbody>
                {items.map((p) => (
                  <tr>
                    <td><a href={`/admin/editor/${p.id}`}>{p.title}</a></td>
                    <td class="cell-slug">
                      /{p.kind === "post" ? `posts/${p.slug}` : p.kind === "home" ? "" : p.slug}
                    </td>
                    <td class="cell-status">
                      {p.published
                        ? <span class="badge badge-published">published</span>
                        : <span class="badge badge-draft">draft</span>}
                    </td>
                    <td class="cell-date">{formatDate(p.date)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      })}
    </div>
  </main>
</AdminLayout>
