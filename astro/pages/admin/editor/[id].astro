---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import PageEditorForm from "../../../components/admin/PageEditorForm.astro";
import { editorRequiresAuth, isAuthenticatedRequest } from "../../../../src/editor/auth.js";
import { initDb } from "../../../../src/shared/db.js";
import { DEFAULT_TENANT_ID } from "../../../../src/shared/types.js";
import { getPageById } from "../../../../src/content/db.js";

if (editorRequiresAuth() && !isAuthenticatedRequest(Astro.request)) {
  return Astro.redirect("/admin/login");
}

const { id } = Astro.params;
if (!id || id === "new" || id === "save" || id === "login" || id === "delete") {
  return Astro.redirect("/admin/editor");
}

const db = await initDb();
const page = await getPageById(db, id, DEFAULT_TENANT_ID);
if (!page) {
  return Astro.redirect("/admin/editor");
}
---
<AdminLayout
  title={`Edit: ${page.title} â€” Admin`}
  scripts={`<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
  <script src="/editor.js"></script>`}
>
  <PageEditorForm page={page} editorBase="/admin/editor" />
</AdminLayout>
